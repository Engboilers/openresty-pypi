worker_processes  1;
master_process off;
daemon off;
error_log /var/log/nginx-error.log;
events {
    worker_connections 1024;
}
http {

	#keepalive_timeout 0;

	types {
		application/x-gzip gz;
	}

    server {

        access_log /var/log/nginx-access.log;

        listen 8080;

       	root /var/www;

       	autoindex on;

        location / {
            try_files $uri  $uri/ @cache;
        }

        location @cache {

            content_by_lua '
                local redis = require "resty.redis"
                local red = redis:new()
                local ok, err = red:connect("127.0.0.1", 6379)

                if not ok then
                    ngx.say("failed to connect: ", err)
                    return
                end

                ok, err = red:rpush("hotqueue:cheeseshop", ngx.var.request_uri)
                if not ok then
                    ngx.say("failed to append to list: ", err)
                    return
                end

                ngx.status = ngx.HTTP_NOT_FOUND
            ';

        }
    }
}